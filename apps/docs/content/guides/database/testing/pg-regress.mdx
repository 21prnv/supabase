---
id: 'pg-regress'
title: 'Testing with pg_regress'
description: 'Use pg_regress for snapshot-based testing of your database, including RLS policies and query results.'
---

# Testing with pg_regress

pg_regress is a powerful testing approach that uses snapshot testing, similar to Jest snapshots in JavaScript. It's particularly useful for testing database behavior, RLS policies, and catching unintended changes in query results.

## Why pg_regress?

1. **Snapshot Testing**: Easily catch unintended changes in database behavior
2. **SQL-Native**: Write tests in pure SQL without learning new testing frameworks
3. **Version Control Friendly**: Changes in behavior are clearly visible in git diffs
4. **Transaction-Based**: Tests run in isolation and don't affect the database state
5. **Concurrent Execution**: Tests can run in parallel since they're transaction-based

## Getting Started

1. Create a test directory structure:

```bash
mkdir -p supabase/tests/regress/{sql,expected}
```

2. Create your first test file (`supabase/tests/regress/sql/schema_test.sql`):

```sql
-- Test database schema structure
begin;

-- Test table existence and structure
\d auth.users;
\d public.todos;

-- Test column existence and types
select
  column_name,
  data_type
from information_schema.columns
where table_schema = 'auth'
  and table_name = 'users'
order by ordinal_position;

-- Test foreign key constraints
select
  tc.table_schema,
  tc.table_name,
  kcu.column_name,
  ccu.table_schema AS foreign_table_schema,
  ccu.table_name AS foreign_table_name,
  ccu.column_name AS foreign_column_name
from information_schema.table_constraints tc
join information_schema.key_column_usage kcu
  on tc.constraint_name = kcu.constraint_name
join information_schema.constraint_column_usage ccu
  on ccu.constraint_name = tc.constraint_name
where tc.constraint_type = 'FOREIGN KEY'
  and tc.table_schema = 'public'
  and tc.table_name = 'todos'
order by kcu.ordinal_position;

rollback;
```

3. Run the test to generate expected output:

```bash
pg_regress --inputdir=supabase/tests/regress/sql --outputdir=supabase/tests/regress/expected schema_test
```

## Example Tests

### 1. Testing Database Structure

File: `supabase/tests/regress/sql/database_structure.sql`

```sql
begin;

-- Test extension availability
select extname, extversion
from pg_extension
where extname in ('pgtap', 'uuid-ossp', 'pg_jwt')
order by extname;

-- Test schema existence
select schema_name
from information_schema.schemata
where schema_name in ('public', 'auth', 'storage')
order by schema_name;

-- Test role existence
select rolname
from pg_roles
where rolname in ('anon', 'authenticated', 'service_role')
order by rolname;

rollback;
```

### 2. Testing RLS Policies

File: `supabase/tests/regress/sql/rls_policies.sql`

```sql
begin;

-- Create test table
create table profiles (
  id uuid primary key default gen_random_uuid(),
  name text,
  user_id uuid references auth.users(id)
);

-- Enable RLS
alter table profiles enable row level security;

-- Create policies
create policy "Public profiles are viewable by everyone"
  on profiles for select using (true);

create policy "Users can insert their own profile"
  on profiles for insert with check (auth.uid() = user_id);

create policy "Users can update own profile"
  on profiles for update using (auth.uid() = user_id);

-- List all policies
select schemaname, tablename, policyname, permissive, roles, cmd, qual
from pg_policies
where tablename = 'profiles'
order by policyname;

-- Test policy effects
-- As anonymous user
set local role anon;
select current_user;
insert into profiles (name, user_id) values ('Test User', 'test-uuid');  -- Should fail
select count(*) from profiles;  -- Should succeed (public read)

-- As authenticated user
set local role authenticated;
set local "request.jwt.claims" to '{"sub": "test-uuid"}';
select current_user;
insert into profiles (name, user_id) values ('Test User', 'test-uuid');  -- Should succeed
insert into profiles (name, user_id) values ('Other User', 'other-uuid');  -- Should fail
update profiles set name = 'Updated Name' where user_id = 'test-uuid';  -- Should succeed
update profiles set name = 'Hacked Name' where user_id = 'other-uuid';  -- Should fail

rollback;
```

### 3. Testing Functions and Triggers

File: `supabase/tests/regress/sql/functions_triggers.sql`

```sql
begin;

-- Create test table with trigger
create table audit_logs (
  id serial primary key,
  table_name text,
  operation text,
  record_id uuid,
  old_data jsonb,
  new_data jsonb,
  timestamp timestamptz default now()
);

-- Create audit function
create or replace function audit_changes()
returns trigger as $$
begin
  insert into audit_logs (table_name, operation, record_id, old_data, new_data)
  values (
    TG_TABLE_NAME,
    TG_OP,
    coalesce(NEW.id, OLD.id),
    case when TG_OP = 'DELETE' then row_to_json(OLD)::jsonb else null end,
    case when TG_OP in ('INSERT', 'UPDATE') then row_to_json(NEW)::jsonb else null end
  );
  return coalesce(NEW, OLD);
end;
$$ language plpgsql security definer;

-- Create test table
create table posts (
  id uuid primary key default gen_random_uuid(),
  title text,
  content text,
  user_id uuid references auth.users(id)
);

-- Add trigger
create trigger posts_audit
after insert or update or delete on posts
for each row execute function audit_changes();

-- Test function info
select
  p.proname,
  p.prorettype::regtype,
  p.prosecdef,
  p.provolatile,
  p.pronargs
from pg_proc p
join pg_namespace n on p.pronamespace = n.oid
where n.nspname = 'public'
  and p.proname = 'audit_changes';

-- Test trigger info
select
  t.tgname,
  t.tgenabled,
  t.tgtype,
  p.proname as trigger_function
from pg_trigger t
join pg_class c on t.tgrelid = c.oid
join pg_proc p on t.tgfoid = p.oid
where c.relname = 'posts'
order by t.tgname;

-- Test trigger functionality
insert into posts (title, content, user_id)
values ('Test Post', 'Content', 'test-uuid');

update posts
set title = 'Updated Post'
where user_id = 'test-uuid';

delete from posts
where user_id = 'test-uuid';

-- Check audit logs
select
  table_name,
  operation,
  old_data->>'title' as old_title,
  new_data->>'title' as new_title
from audit_logs
order by id;

rollback;
```

### 4. Testing Complex RLS Scenarios

File: `supabase/tests/regress/sql/complex_rls.sql`

```sql
begin;

-- Create test tables
create table organizations (
  id uuid primary key default gen_random_uuid(),
  name text not null
);

create table org_members (
  org_id uuid references organizations(id),
  user_id uuid references auth.users(id),
  role text check (role in ('owner', 'admin', 'member')),
  primary key (org_id, user_id)
);

create table projects (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  org_id uuid references organizations(id),
  is_public boolean default false
);

-- Enable RLS
alter table organizations enable row level security;
alter table org_members enable row level security;
alter table projects enable row level security;

-- Create policies
create policy "Users can view organizations they're members of"
  on organizations for select
  using (
    exists (
      select 1 from org_members
      where org_members.org_id = organizations.id
      and org_members.user_id = auth.uid()
    )
  );

create policy "Users can view public projects"
  on projects for select
  using (is_public);

create policy "Users can view private projects in their organizations"
  on projects for select
  using (
    exists (
      select 1 from org_members
      where org_members.org_id = projects.org_id
      and org_members.user_id = auth.uid()
    )
  );

-- Insert test data
insert into organizations (id, name) values
  ('org1-uuid', 'Org 1'),
  ('org2-uuid', 'Org 2');

insert into org_members (org_id, user_id, role) values
  ('org1-uuid', 'user1-uuid', 'admin'),
  ('org1-uuid', 'user2-uuid', 'member'),
  ('org2-uuid', 'user2-uuid', 'owner');

insert into projects (id, name, org_id, is_public) values
  ('proj1-uuid', 'Public Project', 'org1-uuid', true),
  ('proj2-uuid', 'Private Org 1 Project', 'org1-uuid', false),
  ('proj3-uuid', 'Private Org 2 Project', 'org2-uuid', false);

-- Test as different users
-- Test as User 1 (admin in Org 1)
set local role authenticated;
set local "request.jwt.claims" to '{"sub": "user1-uuid"}';

select current_user, current_setting('request.jwt.claims');

-- Should see Org 1 but not Org 2
select id, name from organizations order by name;

-- Should see all Org 1 projects and public projects
select id, name, is_public from projects order by name;

-- Test as User 2 (member in Org 1, owner in Org 2)
set local "request.jwt.claims" to '{"sub": "user2-uuid"}';

select current_user, current_setting('request.jwt.claims');

-- Should see both organizations
select id, name from organizations order by name;

-- Should see all projects
select id, name, is_public from projects order by name;

-- Test as anonymous user
set local role anon;

select current_user;

-- Should see no organizations
select id, name from organizations order by name;

-- Should only see public projects
select id, name, is_public from projects order by name;

rollback;
```

### 5. Testing Storage Policies

File: `supabase/tests/regress/sql/storage_policies.sql`

```sql
begin;

-- Create test bucket
insert into storage.buckets (id, name)
values ('avatars', 'User Avatars');

-- Create storage objects
insert into storage.objects (bucket_id, name, owner, metadata)
values
  ('avatars', 'user1.jpg', 'user1-uuid', '{"size": 1024, "mimetype": "image/jpeg"}'),
  ('avatars', 'user2.jpg', 'user2-uuid', '{"size": 2048, "mimetype": "image/jpeg"}');

-- Test as anonymous user
set local role anon;
select current_user;

-- Should only see public bucket info
select id, name from storage.buckets;

-- Should see no objects
select bucket_id, name, owner from storage.objects;

-- Test as authenticated user
set local role authenticated;
set local "request.jwt.claims" to '{"sub": "user1-uuid"}';

select current_user, current_setting('request.jwt.claims');

-- Should see all buckets
select id, name from storage.buckets;

-- Should only see own objects
select bucket_id, name, owner from storage.objects order by name;

rollback;
```

## Additional Resources

- [Structured Postgres Regression Tests](https://yrashk.com/blog/2023/04/23/structured-postgres-regression-tests/)
- [PostgreSQL pg_regress Documentation](https://www.postgresql.org/docs/current/regress.html)
- [Supabase Management API Tests](https://github.com/supabase/supabase/tree/master/apps/management-api/tests) - Real-world examples
